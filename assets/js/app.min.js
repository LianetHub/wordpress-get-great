(()=>{"use strict";if($(".preloader").length>0){let e=setInterval(function(){let t=$("#percentage"),a=parseInt(t.text());a<90?t.text(++a):a<95&&"interactive"===document.readyState?t.text(95):a<99&&"complete"===document.readyState&&t.text(99),a>=99&&"complete"===document.readyState&&(clearInterval(e),t.text(100),setTimeout(function(){$("body").removeClass("preloading").addClass("is-loaded")},300))},20)}$(function(){$('a[href^="#"]').not("[data-fancybox]").on("click",function(e){const t=this.getAttribute("href");if("#"===t)return;const a=$(t),i=$(".header");if(a.length){e.preventDefault();const t=i.outerHeight()||0,o=a.offset().top-t;$("html, body").stop().animate({scrollTop:o},800)}}),"undefined"!=typeof Fancybox&&null!==Fancybox&&Fancybox.bind("[data-fancybox]",{dragToClose:!1,on:{ready:e=>{const t=e.getSlide();if("#policies"===t.src){const e=$(t.el),a=t.triggerEl;if(a){const t=a.getAttribute("href").replace("#",""),i=e.find(`input[name="policy-type"][value="${t}"]`);i.length?i.prop("checked",!0).trigger("change"):e.find('input[name="policy-type"]:checked').trigger("change"),setTimeout(()=>{i.length?i.prop("checked",!0).trigger("change"):e.find('input[name="policy-type"]:checked').trigger("change")},300)}}},close:(e,t)=>{const a=t.target;if(a&&a.hasAttribute("data-goto-catalog")){const e=$("#catalog"),t=$(".header");if(e.length){const a=t.outerHeight()||0,i=e.offset().top-a;$("html, body").stop().animate({scrollTop:i},800)}}},destroy:e=>{"#cart"===e.getSlide().src&&window?.dornottCart.resetInterface()}}});const e={Android:()=>/Android/i.test(navigator.userAgent),BlackBerry:()=>/BlackBerry/i.test(navigator.userAgent),iOS:()=>/iPhone|iPad|iPod/i.test(navigator.userAgent),Opera:()=>/Opera Mini/i.test(navigator.userAgent),Windows:()=>/IEMobile/i.test(navigator.userAgent),any:function(){return this.Android()||this.BlackBerry()||this.iOS()||this.Opera()||this.Windows()}};function t(){e.any()||$(window).width()<992?$("body").removeClass("_pc").addClass("_touch"):$("body").removeClass("_touch").addClass("_pc")}function a(){const e=$(".steps__item");e.off("click mouseenter mouseleave"),$("body").hasClass("_pc")?e.on("mouseenter",function(){$(this).addClass("active").siblings().removeClass("active")}):e.on("click",function(e){$(this).addClass("active").siblings().removeClass("active")})}t(),a(),$(window).on("resize",()=>{clearTimeout(window.resizeTimer),window.resizeTimer=setTimeout(()=>{t(),a()},100)}),$(document).on("click",e=>{const t=$(e.target);if(t.closest(".menu__arrow").length){const e=t.closest(".menu__arrow").parent();e.hasClass("active")?e.removeClass("active"):($(".menu__item.active").removeClass("active"),e.addClass("active"))}t.closest(".menu__arrow").length||t.closest(".menu").length||$(".menu__item.active").removeClass("active"),t.closest(".menu").length||t.closest(".icon-menu").length||$(".menu__item.active").removeClass("active"),t.closest(".icon-menu").length&&($(".icon-menu").toggleClass("active"),$(".menu").toggleClass("menu--open"),$("body").toggleClass("menu-lock")),!$(".menu").hasClass("menu--open")||t.closest(".menu").length||t.closest(".icon-menu").length||($(".icon-menu").removeClass("active"),$(".menu").removeClass("menu--open"),$("body").removeClass("menu-lock")),$(".menu").hasClass("menu--open")&&t.closest(".menu__link").length&&($(".icon-menu").removeClass("active"),$(".menu").removeClass("menu--open"),$("body").removeClass("menu-lock")),t.closest(".favorite-btn").length&&t.closest(".favorite-btn").toggleClass("active")});var i=document.querySelectorAll('input[type="tel"]'),o=function(e){return e.value.replace(/\D/g,"")},n=function(e){var t=e.target,a=o(t),i=e.clipboardData||window.clipboardData;if(i){var n=i.getData("Text");if(/\D/g.test(n))return void(t.value=a)}},s=function(e){var t=e.target,a=o(t),i=t.selectionStart,n="";if(!a)return t.value="";if(t.value.length==i){if(["7","8","9"].indexOf(a[0])>-1){"9"==a[0]&&(a="7"+a);var s="8"==a[0]?"8":"+7";n=t.value=s+" ",a.length>1&&(n+="("+a.substring(1,4)),a.length>=5&&(n+=") "+a.substring(4,7)),a.length>=8&&(n+="-"+a.substring(7,9)),a.length>=10&&(n+="-"+a.substring(9,11))}else n="+"+a.substring(0,16);t.value=n}else e.data&&/\D/g.test(e.data)&&(t.value=a)},r=function(e){var t=e.target.value.replace(/\D/g,"");8==e.keyCode&&1==t.length&&(e.target.value="")};for(var c of i)c.addEventListener("keydown",r),c.addEventListener("input",s,!1),c.addEventListener("paste",n,!1);const l={type:"fraction",formatFractionCurrent:e=>e<10?"0"+e:e,formatFractionTotal:e=>e<10?"0"+e:e,renderFraction:(e,t)=>'<span class="'+e+'"></span>/<span class="'+t+'"></span>'};if($(".hero").length){const e=$(".hero__images"),t=$(".hero__offer-slider");if(e.length&&t.length){const a=new Swiper(e.get(0),{loop:!0,effect:"fade",fadeEffect:{crossFade:!0},speed:600,allowTouchMove:!1,navigation:{nextEl:".hero__next",prevEl:".hero__prev"},pagination:{el:".hero__pagination",...l}}),i=new Swiper(t.get(0),{loop:!0,autoHeight:!0,speed:600,effect:"fade",fadeEffect:{crossFade:!0},controller:{control:a},breakpoints:{991.98:{autoHeight:!1}}});a.controller.control=i}}if($(".product-card").length){const e=window.matchMedia("(hover: hover)").matches;$(".product-card").each(function(t,a){const i=$(a).find(".product-card__slider");if(!i.length)return;const o=$(a).find(".product-card__pagination")[0],n=new Swiper(i[0],{slidesPerView:1,speed:e?0:400,lazy:!0,watchOverflow:!0,pagination:{el:o,clickable:!0}}),s=n.slides.length;if(s>1){const t=$('<div class="product-card__hover-areas"></div>');t.css({position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",zIndex:10}),e||t[0].style.setProperty("pointer-events","none","important");for(let e=0;e<s;e++){const a=$('<div class="product-card__hover-area"></div>');a.css({flex:"1 1 0"}),a.on("mouseenter",()=>{n.slideTo(e)}),t.append(a)}i.css("position","relative").append(t)}})}if($(".reviews").length){let e;const t=()=>{$(".reviews__text .reviews__slider").length&&!e&&(e=new Swiper(".reviews__text .reviews__slider",{slidesPerView:"auto",spaceBetween:12,watchOverflow:!0,navigation:{nextEl:".reviews__controls--text .reviews__next",prevEl:".reviews__controls--text .reviews__prev"},pagination:{el:".reviews__controls--text .reviews__pagination",...l},breakpoints:{991.98:{slidesPerView:3,spaceBetween:18},1399.98:{slidesPerView:4,spaceBetween:24}}}))};let a;const i=()=>{$(".reviews__screenshots .reviews__slider").length&&!a&&(a=new Swiper(".reviews__screenshots .reviews__slider",{slidesPerView:"auto",spaceBetween:12,watchOverflow:!0,navigation:{nextEl:".reviews__controls--screenshots .reviews__next",prevEl:".reviews__controls--screenshots .reviews__prev"},pagination:{el:".reviews__controls--screenshots .reviews__pagination",...l},breakpoints:{991.98:{slidesPerView:4,spaceBetween:18},1399.98:{slidesPerView:5,spaceBetween:24}}}))},o=$("#reviews"),n=o.find('.reviews__switcher input[name="reviews-type"]'),s=o.find(".reviews__text"),r=o.find(".reviews__screenshots"),c=o.find(".reviews__controls--text"),d=o.find(".reviews__controls--screenshots");"text"===n.filter(":checked").val()?t():i(),n.on("change",function(){const o=$(this).val();"text"===o?(s.show(),r.hide(),c.show(),d.hide(),t()):"screenshots"===o&&(s.hide(),r.show(),c.hide(),d.show(),i()),e&&e.update(),a&&a.update()})}if($(".nav-slider").length){let e=new Swiper(".nav-slider",{slidesPerView:"auto",spaceBetween:4,slideToClickedSlide:!0,initialSlide:$(".nav-slider__item .nav-slider__link.active").parent().index()});$(document).on("change",'#policies input[name="policy-type"]',function(){const t=$(this),a=t.closest("#policies"),i=a.find(".switcher__item").index(t.closest(".switcher__item"));a.find(".popup__text").hide().eq(i).show(),e&&e.slideTo(i)})}$(document).on("change",".product-card .product-card__variations-input",function(){var e=$(this).closest(".product-card"),t=$(this).val(),a=$(this).data("price-html"),i=$(this).data("regular-price-html"),o=!$(this).is(":disabled"),n=e.find('[data-price-role="current-price"]'),s=e.find('[data-price-role="regular-price"]'),r=e.find(".ajax_add_to_cart");n.html(a),s.html(i),r.data("variation-id",t),o?r.removeAttr("disabled"):r.attr("disabled","disabled")}),$(".product-card").each(function(){var e=$(this).find(".product-card__variations-input:checked");e.length&&e.trigger("change")});const d=$(".header");new IntersectionObserver(function(e,t){e[0].isIntersecting?d.removeClass("scroll"):d.addClass("scroll")}).observe(d[0]),$(".switcher").each(function(){var e,t=$(this),a=$('<div class="switcher__slider"></div>');function i(e){if(t.is(":visible")){var a=e.next(".switcher__btn");if(a.length){var i=a.outerWidth(),o=a.offset().left-t.offset().left-parseFloat(t.css("padding-left"));t.css("--active-width",i+"px"),t.css("--active-offset",o+"px")}}}t.prepend(a),new ResizeObserver(function(e){for(var a of e)if(a.contentRect.width>0||a.contentRect.height>0){var o=t.find(".switcher__input:checked");o.length&&i(o)}}).observe(t[0]),t.on("change",".switcher__input",function(){i($(this))}),$(window).on("resize",function(){clearTimeout(e),e=setTimeout(function(){var e=t.find(".switcher__input:checked");e.length&&i(e)},150)})});var h=!1;$(window).scroll(function(){let e=$("#map");if(!h&&e.length>0){let t=document.createElement("script");t.async=!0,t.defer=!0,t.src="https://api-maps.yandex.ru/2.1/?lang=ru_RU";let a=e.offset().top-$(window).height()-200;$(this).scrollTop()>a&&(document.head.append(t),t.onload=function(){!function(){const e=$("#map");for(var t=e.data("coords").split("; "),a=e.data("placemark-logo"),i=0;i<t.length;i++){t[i]=t[i].split(", ");for(var o=0;o<t[i].length;o++)t[i][o]=parseFloat(t[i][o])}var n=t[0].map(function(e){return e});ymaps.ready(function(){var e=new ymaps.Map("map",{center:n,zoom:16,controls:[]}),i=new ymaps.Placemark(t[0],{},{iconLayout:"default#image",iconImageHref:a,iconImageSize:[69,78],iconImageOffset:[-35,-78]}),o=new ymaps.control.ZoomControl({options:{position:{right:10,top:200}}});e.behaviors.disable("scrollZoom"),e.controls.add(o),e.geoObjects.add(i)})}()},h=!0)}}),window.formController=new class{constructor(){this.selectors={field:".form__field",errorClass:"_error",loadingClass:"_loading",requiredAttr:"[data-required]",fileInput:".form__file-input",fileContainer:".form__file",fileRemove:".form__file-remove",submitBtn:'[type="submit"]'},this.init()}init(){const e=this;$("form").each(function(){e.bindSubmit($(this))}),$(document).on("input change",this.selectors.requiredAttr,e=>{const t=$(e.target);(t.hasClass(this.selectors.errorClass)||t.closest(this.selectors.field).hasClass(this.selectors.errorClass))&&this.toggleErrorState(t,!0)}),$(document).on("keydown",'input[type="tel"]',e=>this.onPhoneKeyDown(e)),$(document).on("input",'input[type="tel"]',e=>this.onPhoneInput(e)),$(document).on("paste",'input[type="tel"]',e=>this.onPhonePaste(e)),$(document).on("focus",'input[type="tel"]',e=>{e.target.value||(e.target.value="+7 ")}),$(document).off("change",this.selectors.fileInput).on("change",this.selectors.fileInput,e=>this.handleFileChange(e)),$(document).off("click",this.selectors.fileRemove).on("click",this.selectors.fileRemove,e=>this.handleFileRemove(e))}bindSubmit(e){e.on("submit",async t=>{"cart-form"!==e.attr("id")&&(t.preventDefault(),this.validateForm(e)&&await this.sendForm(e))})}async sendForm(e,t=!1){console.log("submit from form controller");const a=e.attr("action"),i=e.attr("method")||"POST",o=new FormData(e[0]),n=e.find(this.selectors.submitBtn);n.addClass(this.selectors.loadingClass);try{const n=await fetch(a,{method:i,body:o});if(n.ok){const a=await n.json();if(a.success){if(e[0].reset(),e.find(".form__file-preview").remove(),e.find(".uploaded").removeClass("uploaded"),window.dornottCart&&"cart-form"===e.attr("id")&&(localStorage.removeItem(window.dornottCart.storageKey),window.dornottCart.updateInterface()),!t){const e=Fancybox.getInstance();e&&e.destroy(),Fancybox.show([{src:"#success-submitting",type:"inline"}]),"function"==typeof ym&&ym(105964434,"reachGoal","sendmail")}}else console.error("Ошибка логики сервера:",a.data.message),this.showErrorPopup()}else console.error("Ошибка сервера (HTTP статус)"),this.showErrorPopup()}catch(e){console.error("Ошибка сети",e),this.showErrorPopup()}finally{n.removeClass(this.selectors.loadingClass)}}showErrorPopup(){const e=Fancybox.getInstance();e&&e.destroy(),Fancybox.show([{src:"#error-submitting",type:"inline"}])}validateField(e){if(!e.is(":visible"))return this.toggleErrorState(e,!0),!0;const t=e.attr("type"),a=e.attr("name"),i=e.val()?e.val().trim():"";let o=!0;return o="checkbox"===t?e.is(":checked"):"username"===a?/^[^\d]+$/.test(i)&&i.length>1:"tel"===t?i.replace(/\D/g,"").length>=11:"email"===t?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i):"city"===a?i.length>=2:"address"===a?i.length>=5:""!==i,this.toggleErrorState(e,o),o}toggleErrorState(e,t){e.closest(this.selectors.field).toggleClass(this.selectors.errorClass,!t),e.toggleClass(this.selectors.errorClass,!t)}validateForm(e){let t=!0;const a=this;return e.find(this.selectors.requiredAttr).each(function(){a.validateField($(this))||(t=!1)}),t}handleFileChange(e){const t=$(e.currentTarget).closest(this.selectors.fileContainer),a=e.target.files[0];if(t.find(".form__file-preview").remove(),t.removeClass("uploaded"),a){const e=a.type.match("image.*"),i=new FileReader;i.onload=i=>{let o="";e&&(o=`\n                        <span class="form__file-image">\n                            <img src="${i.target.result}" alt="Превью" class="cover-image">\n                        </span>\n                    `);const n=`\n                    <div class="form__file-preview">\n                        ${o}\n                        <span class="form__file-name">${a.name}</span>\n                        <button type="button" aria-label="Удалить" class="form__file-remove icon-cross"></button>\n                    </div>\n                `;t.append(n),t.addClass("uploaded")},i.readAsDataURL(a)}}handleFileRemove(e){e.preventDefault(),e.stopPropagation();const t=$(e.currentTarget),a=t.closest(this.selectors.fileContainer),i=t.closest(".form__file-preview");a.find(this.selectors.fileInput).val(""),a.removeClass("uploaded"),i.remove()}onPhoneInput(e){const t=e.target;let a=t.value.replace(/\D/g,"");const i=t.selectionStart;let o="";if(!a)return t.value="";t.value.length==i?(a.length>11&&(a=a.substring(0,11)),o="+7 (",a.length>=2&&(o+=a.substring(1,4)),a.length>=5&&(o+=") "+a.substring(4,7)),a.length>=8&&(o+="-"+a.substring(7,9)),a.length>=10&&(o+="-"+a.substring(9,11)),t.value=o):e.originalEvent.data&&/\D/g.test(e.originalEvent.data)&&(t.value=a)}onPhoneKeyDown(e){const t=e.target.value.replace(/\D/g,"");8==e.keyCode&&1==t.length&&(e.target.value="")}onPhonePaste(e){const t=e.target,a=t.value.replace(/\D/g,""),i=e.originalEvent.clipboardData||window.clipboardData;if(i){const e=i.getData("Text");/\D/g.test(e)&&(t.value=a)}}},window.dornottCart=new class{constructor(){this.$cartModal=$("#cart"),this.storageKey="dornott_cart",this.$form=$("#cart-form"),this.$cartBody=$(".cart__body"),this.$container=$("#cart-items-container"),this.$cartToggler=$("[data-cart-toggler]"),this.$addressStep=this.$form.find(".order__step").eq(2),this.$checkoutBtn=$("#checkout-button"),this.$paymentContainer=$("#payment-container"),this.$cartTitle=$(".cart__title"),this.init()}init(){this.bindEvents(),this.updateInterface(),this.toggleAddressStep()}getData(){return JSON.parse(localStorage.getItem(this.storageKey))||[]}saveData(e){localStorage.setItem(this.storageKey,JSON.stringify(e)),this.updateInterface()}showTooltip(e,t,a="success"){$(".tooltip").remove();const i=$(`<div class="tooltip ${a}"></div>`).text(t);$("body").append(i);const o=e.offset(),n=i.outerWidth(),s=i.outerHeight(),r=e.outerWidth(),c=e.outerHeight();let l=o.top-s-10,d=o.left+r-n;l<$(window).scrollTop()?(l=o.top+c+10,i.addClass("open-bottom")):i.addClass("open-top"),d<5&&(d=5),i.css({top:l,left:d,position:"absolute",opacity:0,display:"block"}).animate({opacity:1},200),setTimeout(()=>{i.fadeOut(300,function(){$(this).remove()})},2e3)}bindEvents(){$(document).on("click",".toggle-to-cart-button",e=>this.handleAddToCart(e)),$(document).on("click",".quantity-block__up",e=>this.changeQty(e,1)),$(document).on("click",".quantity-block__down",e=>this.changeQty(e,-1)),$(document).on("change",".quantity-block__input",e=>this.handleQtyInput(e)),$(document).on("click",".cart__item-remove",e=>{const t=$(e.target),a=t.closest(".cart__item").data("id");this.removeItem(a),this.showTooltip(t,"Товар удален","")}),$(document).on("change",'input[name="delivery"]',()=>{this.updateInterface(),this.toggleAddressStep()}),$(document).on("change",'input[name="select_all"]',e=>this.toggleAllCheckboxes(e)),$(document).on("change",".cart__item-checkbox .checkbox__input",()=>this.updateSelectAllState()),$(document).on("click",".cart__clear",e=>{this.removeSelected(),this.showTooltip($(e.currentTarget),"Выбранные товары удалены","")}),$(document).on("change",".product-card__variations-input",e=>this.handleVariationChange(e)),this.$form.on("submit",e=>this.handleSubmit(e)),this.$form.on("input change","[data-required]",()=>this.validateForm())}handleAddToCart(e){const t=$(e.currentTarget),a=t.closest(".product-card"),i=t.data("variation-id")||t.data("product-id");if(t.hasClass("active"))this.removeItem(i),t.removeClass("active"),this.showTooltip(t,"Удалено из корзины","");else{const e=parseInt(a.find('[data-price-role="current-price"]').text().replace(/\D/g,"")),o=parseInt(a.find('[data-price-role="regular-price"]').text().replace(/\D/g,""))||e,n=a.find(".price-block__sale").text().trim(),s={id:i,name:a.find(".product-card__title").text().trim(),sku:a.find(".product-card__sku").text().trim(),price:e,regular_price:o,sale_label:n,image:a.find(".product-card__image").first().attr("src"),quantity:1};this.addItem(s),t.addClass("active"),this.showTooltip(t,"Товар добавлен в корзину","success")}}addItem(e){let t=this.getData();-1===t.findIndex(t=>t.id===e.id)&&t.push(e),this.saveData(t)}removeItem(e){let t=this.getData();t=t.filter(t=>t.id!==e),this.saveData(t),$(`.toggle-to-cart-button[data-product-id="${e}"], .toggle-to-cart-button[data-variation-id="${e}"]`).removeClass("active")}changeQty(e,t){const a=$(e.currentTarget).siblings(".quantity-block__input"),i=$(e.currentTarget).closest(".cart__item").data("id");let o=parseInt(a.val())||1;o=Math.min(999,Math.max(1,o+t)),a.val(o),this.updateQuantity(i,o)}handleQtyInput(e){const t=$(e.currentTarget),a=t.closest(".cart__item").data("id");let i=parseInt(t.val().replace(/\D/g,""))||1;i=Math.min(999,Math.max(1,i)),t.val(i),this.updateQuantity(a,i)}updateQuantity(e,t){let a=this.getData();const i=a.findIndex(t=>t.id===e);i>-1&&(a[i].quantity=t,this.saveData(a))}validateForm(){let e=!0;return this.$form.find("[data-required]").each((t,a)=>{window.formController&&!window.formController.validateField($(a))&&(e=!1)}),$("#cart-validation-warning").toggleClass("hidden",e),e}toggleAllCheckboxes(e){const t=$(e.currentTarget).is(":checked");$(".cart__item-checkbox .checkbox__input").prop("checked",t)}updateSelectAllState(){const e=$(".cart__item-checkbox .checkbox__input").length,t=$(".cart__item-checkbox .checkbox__input:checked").length;$('input[name="select_all"]').prop("checked",e===t&&e>0)}removeSelected(){$(".cart__item-checkbox .checkbox__input:checked").each((e,t)=>{this.removeItem($(t).closest(".cart__item").data("id"))})}handleVariationChange(e){const t=$(e.currentTarget),a=t.closest(".product-card"),i=a.find(".toggle-to-cart-button");a.find('[data-price-role="current-price"]').html(t.data("price-html")),a.find('[data-price-role="regular-price"]').html(t.data("regular-price-html"));const o=t.val();i.data("variation-id",o);const n=this.getData();i.toggleClass("active",n.some(e=>e.id==o))}calculateTotals(){const e=this.getData(),t=parseInt($('input[name="delivery"]:checked').data("price"))||0;let a=0,i=0,o=0;return e.forEach(e=>{a+=e.regular_price*e.quantity,i+=(e.regular_price-e.price)*e.quantity,o+=e.quantity}),{subtotal:a,discount:i,totalQty:o,deliveryPrice:t,finalPrice:a-i+t}}updateInterface(){const e=this.getData(),t=this.calculateTotals();e.length>0?(this.$cartBody.show(),$("#cart-empty-state").hide(),this.$cartToggler.find(".cart-quantity").length||this.$cartToggler.append('<span class="cart-quantity"></span>'),this.$cartToggler.find(".cart-quantity").text(t.totalQty)):(this.$cartBody.hide(),$("#cart-empty-state").show(),this.$cartToggler.find(".cart-quantity").remove()),$("#total-qty").text(`${t.totalQty} шт.`),$("#subtotal-price").text(`${t.subtotal.toLocaleString()} ₽`),$("#total-discount").text(`${t.discount.toLocaleString()} ₽`),$("#delivery-price").text(`${t.deliveryPrice.toLocaleString()} ₽`),$("#final-price").text(`${t.finalPrice.toLocaleString()} ₽`),this.$form.find('input[name="delivery_price"]').val(t.deliveryPrice),this.renderItems(e),this.syncButtons(e)}toggleAddressStep(){const e=$('input[name="delivery"]:checked').val();this.$addressStep.length&&("pickup"===e?(this.$addressStep.hide(),window.formController&&this.$addressStep.find("."+window.formController.selectors.errorClass).removeClass(window.formController.selectors.errorClass)):this.$addressStep.show())}syncButtons(e){$(".toggle-to-cart-button").each((t,a)=>{const i=$(a),o=i.data("variation-id")||i.data("product-id");i.toggleClass("active",e.some(e=>e.id==o))})}renderItems(e){this.$container.empty(),e.forEach(e=>{this.$container.append(`\n                <div class="cart__item" data-id="${e.id}">\n                    <div class="cart__item-block cart__item-block--details">\n                        <label class="cart__item-checkbox checkbox">\n                            <input type="checkbox" class="checkbox__input hidden" hidden checked>\n                            <span class="checkbox__text"></span>\n                        </label>\n                        <div class="cart__item-thumb"><img src="${e.image}"></div>\n                        <div class="cart__item-info">\n                            <div class="cart__item-sku">${e.sku}</div>\n                            <div class="cart__item-name">${e.name}</div>\n                        </div>\n                    </div>\n                    <div class="cart__item-block cart__item-block--quantity">\n                        <div class="quantity-block">\n                            <button type="button" class="quantity-block__down icon-minus"></button>\n                            <input type="number" class="quantity-block__input" value="${e.quantity}">\n                            <button type="button" class="quantity-block__up icon-plus"></button>\n                        </div>\n                    </div>\n                    <div class="cart__item-block cart__item-block--price">\n                        <div class="cart__item-price price-block">\n                            <div class="price-block__header">\n                                <div class="price-block__old">${e.regular_price>e.price?e.regular_price.toLocaleString()+" ₽":""}</div>\n                                <div class="price-block__sale">${e.sale_label||""}</div>\n                            </div>\n                            <div class="price-block__current">${e.price.toLocaleString()} ₽</div>\n                        </div>\n                        <button type="button" class="cart__item-remove icon-cross"></button>\n                    </div>\n                </div>\n            `)}),this.updateSelectAllState()}async handleSubmit(e){if(e.preventDefault(),this.validateForm()){this.$checkoutBtn.addClass("_loading");const e={order_info:this.$form.serializeArray().filter(e=>"select_all"!==e.name),items:this.getData(),totals:this.calculateTotals()};try{const t=await fetch("/wp-admin/admin-ajax.php?action=init_tbank_payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),a=await t.json();a.success&&a.data.paymentUrl?this.openPaymentIframe(a.data.paymentUrl,a.data.orderId):(console.error("Ошибка инициализации платежа",a.data.message),this.$checkoutBtn.removeClass("_loading"))}catch(e){console.error("Произошла сетевая ошибка:",e),this.$checkoutBtn.removeClass("_loading")}}}async openPaymentIframe(e,t){if(window.tbankSDK){this.$cartModal.addClass("open-payment"),this.$paymentContainer.show(),this.$form.hide(),this.$cartTitle.text("Оплата заказа"),t&&this.$form.find('input[name="order_id"]').val(t);try{const a="dornott-checkout-frame",i={REJECTED:"Платеж отклонен банком. Проверьте данные карты, баланс или попробуйте другую карту.",CANCELED:"Оплата была отменена. Если это произошло случайно, вы можете попробовать еще раз.",EXPIRED:"Время на оплату истекло. Пожалуйста, создайте новый заказ.",PROCESSING_ERROR:"Произошла техническая ошибка при обработке данных. Пожалуйста, попробуйте позже.",default:"Произошла непредвиденная ошибка при оплате. Попробуйте еще раз или свяжитесь с поддержкой."},o={status:{changedCallback:async e=>{if(console.log("T-Bank Payment Status:",e),"SUCCESS"===e){"function"==typeof ym&&ym(105964434,"reachGoal","payment_ok");let e=[];try{const t=localStorage.getItem(this.storageKey);if(t){const a=JSON.parse(t);Array.isArray(a)?e=a:a&&a.items&&(e=a.items)}}catch(e){console.error("Error reading cart for email",e)}this.$form.find('input[name="cart_items"]').val(JSON.stringify(e)),window.formController&&await window.formController.sendForm(this.$form,!0),localStorage.removeItem(this.storageKey),await this.resetInterface();const a=Fancybox.getInstance();a&&a.destroy();const i=$("#success-order");t&&i.find(".order-number").text(`№ ${t}`),Fancybox.show([{src:"#success-order",type:"inline",autoFocus:!1}])}else if(["REJECTED","CANCELED","EXPIRED","PROCESSING_ERROR"].includes(e)){const t=i[e]||i.default;await this.resetInterface();const a=Fancybox.getInstance();a&&a.destroy(),$("#error-order").find(".popup__subtitle").text(t),setTimeout(()=>{Fancybox.show([{src:"#error-order",type:"inline",autoFocus:!1,trapFocus:!1,placeFocusBack:!1}])},100)}}}};this.currentPaymentWidget=await window.tbankSDK.iframe.create(a,o);const n=this.$paymentContainer[0];await this.currentPaymentWidget.mount(n,e)}catch(e){console.error("Iframe mount error:",e),this.resetInterface()}}else console.error("SDK не инициализирован")}async resetInterface(){if(this.currentPaymentWidget)try{await this.currentPaymentWidget.unmount(),this.currentPaymentWidget=null}catch(e){console.warn("Ошибка при unmount:",e)}this.$paymentContainer.hide().html(""),this.$form.show(),this.$cartTitle.text("Корзина"),this.$checkoutBtn.removeClass("_loading"),this.$cartModal.removeClass("open-payment")}}})})();